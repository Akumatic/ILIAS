/**
 * This file is part of ILIAS, a powerful learning management system
 * published by ILIAS open source e-Learning e.V.
 *
 * ILIAS is licensed with the GPL-3.0,
 * see https://www.gnu.org/licenses/gpl-3.0.en.html
 * You should have received a copy of said license along with the
 * source code, too.
 *
 * If this is not the case or you just want to try ILIAS, you'll find
 * us at:
 * https://www.ilias.de
 * https://github.com/ILIAS-eLearning
 */
!function(e,t){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=i(e),n=i(t);n.default.WOPI={modified:!1},n.default.WOPI.bindCloseButton=function(e){a.default.getElementById(e).addEventListener("click",(async e=>{e.stopPropagation(),e.preventDefault();return await this.close()}))},n.default.WOPI.windowResize=function(){const e=this.editorFrame.parentElement.offsetWidth-0,t=a.default.getElementsByClassName("il-layout-page-content")[0].clientHeight-a.default.getElementsByClassName("il_HeaderInner")[0].clientHeight-a.default.getElementsByTagName("footer")[0].clientHeight-100;this.editorFrame.setAttribute("width",e),this.editorFrame.setAttribute("height",t)},n.default.WOPI.init=function(){
// BUILD IFRAME
const e=a.default.getElementById("c-embedded-wopi"),t=e.getAttribute("data-token"),i=e.getAttribute("data-editor-url"),s=e.getAttribute("data-ttl"),d=a.default.createElement("iframe");
// read ttl, token and editor URL from data attributes
d.name="editor_frame",d.id="editor_frame",d.title="Office Frame",d.setAttribute("allowfullscreen","true"),d.setAttribute("allowtransparency","true"),d.setAttribute("frameBorder","0"),e.appendChild(d),this.frameholder=e,this.editorFrame=d,
// eslint-disable-next-line max-len
this.editorFrameWindow=d.contentWindow||d.contentDocument.document||d.contentDocument,this.windowResize();
// BUILD FORM
const o=a.default.createElement("form"),r=a.default.createElement("input"),l=a.default.createElement("input");o.method="POST",o.action=i,o.target="editor_frame",r.name="access_token",r.value=t,o.appendChild(r),l.name="access_token_ttl",l.value=s,o.appendChild(l),a.default.body.appendChild(o),
// SEND FORM
o.submit(),
// Add event listener to receive messages from the editor
this.registerListener("App_LoadingStatus",(()=>{this.postMessage({MessageId:"Host_PostmessageReady",SendTime:Date.now(),Values:{}})})),
// Collabora
this.registerListener("Doc_ModifiedStatus",(e=>{this.modified=e.Values.Modified??!1})),
// OnlyOffice
this.registerListener("Edit_Notification",(()=>{this.modified=!0})),
// Add event listener to resize the editor iframe
a.default.defaultView.addEventListener("resize",(()=>{n.default.WOPI.windowResize(d)})),
// resize after some time to make sure the editor is loaded and mainmenu has been collapsed
setTimeout((()=>{n.default.WOPI.windowResize(d)}),200)},n.default.WOPI.postMessage=function(e){this.editorFrameWindow.postMessage(JSON.stringify(e),"*")},n.default.WOPI.registerListener=function(e,t){window.addEventListener("message",(i=>{const a=JSON.parse(i.data);null!==e&&a.MessageId===e&&t(a)}),!1)},n.default.WOPI.close=async function(){const e=a.default.createElement("div");e.id="c-embedded-wopi-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(255,255,255,0.7)",this.frameholder.appendChild(e);const t=await this.save();return!this.modified||t},n.default.WOPI.save=async function(){this.postMessage({MessageId:"Action_Save",SendTime:Date.now(),Values:{DontTerminateEdit:!0,DontSaveIfUnmodified:!0,Notify:!1}});return await this.registerListener("Doc_ModifiedStatus",(()=>!0))}}(document,il);
