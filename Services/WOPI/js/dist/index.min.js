/**
 * This file is part of ILIAS, a powerful learning management system
 * published by ILIAS open source e-Learning e.V.
 *
 * ILIAS is licensed with the GPL-3.0,
 * see https://www.gnu.org/licenses/gpl-3.0.en.html
 * You should have received a copy of said license along with the
 * source code, too.
 *
 * If this is not the case or you just want to try ILIAS, you'll find
 * us at:
 * https://www.ilias.de
 * https://github.com/ILIAS-eLearning
 */
!function(e,t){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=i(e),o=i(t);o.default.WOPI={modified:!1},o.default.WOPI.init=function(){
// BUILD IFRAME
const e=s.default.getElementById("c-embedded-wopi"),t=e.getAttribute("data-token"),i=e.getAttribute("data-editor-url"),a=e.getAttribute("data-ttl"),d=s.default.createElement("iframe");
// read ttl, token and editor URL from data attributes
d.name="editor_frame",d.id="editor_frame",d.title="Office Frame",d.setAttribute("allowfullscreen","true"),d.setAttribute("allowtransparency","true"),d.setAttribute("frameBorder","0"),e.appendChild(d),this.frameholder=e,this.editorFrame=d,
// eslint-disable-next-line max-len
this.editorFrameWindow=d.contentWindow||d.contentDocument.document||d.contentDocument,this.windowResize();
// BUILD FORM
const n=s.default.createElement("form"),l=s.default.createElement("input"),r=s.default.createElement("input");n.method="POST",n.action=i,n.target="editor_frame",l.name="access_token",l.value=t,n.appendChild(l),r.name="access_token_ttl",r.value=a,n.appendChild(r),s.default.body.appendChild(n),
// SEND FORM
n.submit(),
// Add event listener to receive messages from the editor
this.registerListener("App_LoadingStatus",(e=>{"Document_Loaded"===e.Values.Status&&this.postMessage({MessageId:"Host_PostmessageReady",SendTime:Date.now(),Values:{}})})),this.registerListener("Doc_ModifiedStatus",(e=>{console.log("Documend Modified"),this.modified=e.Values.Modified??!1})),
// Add event listener to resize the editor iframe
s.default.defaultView.addEventListener("resize",(()=>{o.default.WOPI.windowResize(d)}))},o.default.WOPI.windowResize=function(){const e=this.editorFrame.parentElement.offsetWidth-0,t=s.default.getElementsByClassName("il-layout-page-content")[0].clientHeight-s.default.getElementsByClassName("il_HeaderInner")[0].clientHeight-s.default.getElementsByTagName("footer")[0].clientHeight-100;this.editorFrame.setAttribute("width",e),this.editorFrame.setAttribute("height",t)},o.default.WOPI.postMessage=function(e){this.editorFrameWindow.postMessage(JSON.stringify(e),"*")},o.default.WOPI.registerListener=function(e,t){window.addEventListener("message",(i=>{const s=JSON.parse(i.data);null!==e&&s.MessageId===e&&t(s),null===e&&t(s)}),!1)},o.default.WOPI.close=function(e){console.log("save called");const t=s.default.createElement("div");if(t.id="c-embedded-wopi-overlay",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0,0,0,0.5)",this.frameholder.appendChild(t),this.modified){console.log("is modified");new Promise(((t,i)=>{console.log("save"),this.save(),this.registerListener("Doc_ModifiedStatus",e),saved_internal.then((()=>{e()}))})).then(null,(e=>{console.log(e)}))}else e();this.modified?(console.log("is modified"),
// wait for the editor to send the message that the document is saved
console.log("register listener")):e()},o.default.WOPI.save=function(){this.postMessage({MessageId:"Action_Save",SendTime:Date.now(),Values:{DontTerminateEdit:!0,DontSaveIfUnmodified:!0,Notify:!1}})}}(document,il);
